
<!DOCTYPE html>
<html lang="vi">
<head>
  
  <meta charset=\"UTF-8\" />
  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, viewport-fit=cover\" />
  <link rel=\"manifest\" href=\"manifest.json\" />
  <link rel=\"apple-touch-icon\" href=\"apple-touch-icon.png\" />
  <meta name=\"apple-mobile-web-app-capable\" content=\"yes\" />
  <meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black-translucent\" />
  <meta name=\"theme-color\" content=\"#6c63ff\" />
  <style>
    :root { --primary:#6c63ff; --primary-dark:#524bdf; --bg:#f7f8fc; --card:#fff; --text:#222; --muted:#67728a; --accent:#00bfa6; --danger:#ff5d5d; --ok:#00b37d; --warn:#f0a500; --n1:#2296f3; --n2:#f0a500; --n3:#ff5d5d; --rem:#9c27b0; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,\"Helvetica Neue\",Arial; background:var(--bg); color:var(--text); margin:0; -webkit-font-smoothing:antialiased}
    header{background:linear-gradient(135deg,var(--primary),#9c92ff); color:#fff; padding:24px 16px; text-align:center; box-shadow:0 6px 16px rgba(0,0,0,.12)}
    main{max-width:980px; margin:24px auto; padding:0 16px 40px}
    .card{background:var(--card); border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08); overflow:hidden}
    .section-card{background:var(--card); border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08); padding:18px; margin-top:18px}
    .tabs{display:flex; border-bottom:1px solid #e8eaf1; background:#fafbff}
    .tab{flex:1; text-align:center; padding:16px 12px; cursor:pointer; font-weight:600; color:var(--muted); display:flex; align-items:center; justify-content:center; gap:8px; min-height:48px}
    .tab.active{color:var(--primary); background:#fff; border-bottom:2px solid var(--primary)}
    .pane{padding:20px; display:none}
    .pane.active{display:block}
    .hero-input{text-align:center; margin:8px 0 12px}
    .hero-input label{font-size:1rem; color:var(--muted)}
    .hm-wrap{margin-top:12px; display:flex; justify-content:center; align-items:center; gap:10px}
    .hm{display:flex; align-items:center; gap:6px}
    .hm input{width:100px; font-size:2rem; padding:16px 18px; text-align:center; border:2px solid #e3e6ef; border-radius:12px; outline:none; background:#fbfbff}
    .hm input:focus{border-color:var(--primary); box-shadow:0 0 0 8px rgba(108,99,255,.12)}
    .colon{font-size:2rem; font-weight:700; color:#444; user-select:none}
    .time-help{color:var(--muted); font-size:.95rem; margin-top:8px; text-align:center}
    .controls{display:grid; grid-template-columns:1fr; gap:12px; margin-top:10px}
    .button{padding:16px 18px; border:none; border-radius:12px; font-weight:700; cursor:pointer; min-height:48px}
    .btn-primary{background:var(--primary); color:#fff}
    .btn-primary:hover{background:var(--primary-dark)}
    .toggle{display:flex; align-items:center; gap:8px; justify-content:center; color:var(--muted); font-size:1rem}
    .results{margin-top:16px}
    .recommend{background:#f2f7ff; border:1px solid #d7e3ff; padding:16px; border-radius:12px; display:flex; align-items:center; gap:12px; margin-bottom:16px}
    .badge{background:var(--accent); color:#fff; padding:8px 10px; border-radius:999px; font-size:.9rem; font-weight:700}
    .list{display:grid; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); gap:10px}
    .list .item{background:#f8f9ff; border:1px solid #e3e6ef; border-radius:10px; padding:14px; text-align:center; font-weight:700; color:#333}
    .item small{display:block; color:var(--muted); font-weight:600; margin-top:4px}
    .rows{width:100%; border-collapse:collapse; margin-top:12px}
    .rows th, .rows td{border-bottom:1px solid #eef1f7; padding:12px 10px; text-align:left; vertical-align:top}
    .rows th{color:#556; font-size:1rem}
    .stage{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; color:#fff; font-size:.9rem; font-weight:700}
    .stage-n1{background:#2296f3}
    .stage-n2{background:#f0a500}
    .stage-n3{background:#ff5d5d}
    .stage-rem{background:#9c27b0}
    .stage-end{background:#00b37d}
    .tag{padding:4px 10px; border-radius:999px; font-size:.9rem; font-weight:700; color:#fff; display:inline-block}
    .tag-good{background:#00b37d}
    .tag-mid{background:#f0a500}
    .tag-bad{background:#ff5d5d}
    .evalBox{font-size:1rem; color:#334}
    .evalBox p{margin:8px 0}
    footer{text-align:center; color:#67728a; padding:24px 8px}
    *{-webkit-tap-highlight-color: transparent}
    .scroll{overflow-x:auto; -webkit-overflow-scrolling: touch}
  </style>

  <title>M√°y t√≠nh Chu k·ª≥ Ng·ªß ‚Äì PRO v6.1</title>
</head>
<body>
  <header>
    <h1>üõå M√°y t√≠nh Chu k·ª≥ Ng·ªß ‚Äì PRO v6.1</h1>
    <p>PWA ‚Äì t·ªëi ∆∞u cho iPhone: th√™m v√†o m√†n h√¨nh ch√≠nh, d√πng offline, ch·∫°m d·ªÖ.</p>
  </header>
  <main>
    <div class="card">
      <div class="tabs">
        <div class="tab active" data-tab="wake">‚è∞ T√≠nh gi·ªù <strong>th·ª©c d·∫≠y</strong></div>
        <div class="tab" data-tab="bed">üåô T√≠nh gi·ªù <strong>ƒëi ng·ªß</strong></div>
      </div>
      <div class="pane active" id="pane-wake">
        <div class="hero-input">
          <label>Nh·∫≠p <strong>gi·ªù ƒëi ng·ªß</strong> (24h ‚Äì HH:MM)</label>
          <div class="hm-wrap">
            <div class="hm"><input id="bedHH" maxlength="2" inputmode="numeric" placeholder="23" aria-label="Gi·ªù (00‚Äì23)"></div>
            <div class="colon">:</div>
            <div class="hm"><input id="bedMM" maxlength="2" inputmode="numeric" placeholder="15" aria-label="Ph√∫t (00‚Äì59)"></div>
          </div>
          <div class="time-help">Ch·ªâ nh·∫≠p s·ªë: <b>00‚Äì23</b> cho gi·ªù, <b>00‚Äì59</b> cho ph√∫t</div>
        </div>
        <div class="controls">
          <button class="button btn-primary" onclick="calcWakeFromBed()">üí° T√≠nh gi·ªù th·ª©c d·∫≠y</button>
          <label class="toggle"><input type="checkbox" id="includeLatencyBed" checked> Bao g·ªìm ~15‚Äô ch√¨m v√†o gi·∫•c</label>
        </div>
        <div class="results" id="resultsBed"></div>
      </div>
      <div class="pane" id="pane-bed">
        <div class="hero-input">
          <label>Nh·∫≠p <strong>gi·ªù th·ª©c d·∫≠y</strong> (24h ‚Äì HH:MM)</label>
          <div class="hm-wrap">
            <div class="hm"><input id="wakeHH" maxlength="2" inputmode="numeric" placeholder="06" aria-label="Gi·ªù (00‚Äì23)"></div>
            <div class="colon">:</div>
            <div class="hm"><input id="wakeMM" maxlength="2" inputmode="numeric" placeholder="30" aria-label="Ph√∫t (00‚Äì59)"></div>
          </div>
          <div class="time-help">Ch·ªâ nh·∫≠p s·ªë: <b>00‚Äì23</b> cho gi·ªù, <b>00‚Äì59</b> cho ph√∫t</div>
        </div>
        <div class="controls">
          <button class="button btn-primary" onclick="calcSleepFromWake()">üí§ T√≠nh gi·ªù ƒëi ng·ªß</button>
          <label class="toggle"><input type="checkbox" id="includeLatencyWake" checked> Bao g·ªìm ~15‚Äô ch√¨m v√†o gi·∫•c</label>
        </div>
        <div class="results" id="resultsWake"></div>
      </div>
    </div>

    <div class="section-card scroll">
      <h3>üìù Ghi nh·∫≠n gi·∫•c ng·ªß (ƒë√°nh gi√° theo giai ƒëo·∫°n)</h3>
      <div class="hero-input">
        <label>ƒêi ng·ªß (24h ‚Äì HH:MM)</label>
        <div class="hm-wrap">
          <div class="hm"><input id="logBedHH" maxlength="2" inputmode="numeric" placeholder="22"></div>
          <div class="colon">:</div>
          <div class="hm"><input id="logBedMM" maxlength="2" inputmode="numeric" placeholder="45"></div>
        </div>
      </div>
      <div class="hero-input" style="margin-top:6px">
        <label>Th·ª©c d·∫≠y (24h ‚Äì HH:MM)</label>
        <div class="hm-wrap">
          <div class="hm"><input id="logWakeHH" maxlength="2" inputmode="numeric" placeholder="07"></div>
          <div class="colon">:</div>
          <div class="hm"><input id="logWakeMM" maxlength="2" inputmode="numeric" placeholder="15"></div>
        </div>
        <div class="toggle" style="margin-top:8px">
          <input type="checkbox" id="logIncludeLatency" checked> <span>Tr·ª´ ~15‚Äô ƒë·ªÉ l·∫•y <b>th·ª±c ng·ªß</b></span>
        </div>
      </div>
      <div class="controls">
        <button class="button btn-primary" onclick="addLog()">‚ûï Ghi nh·∫≠n</button>
      </div>

      <table class="rows" id="logTable">
        <thead>
          <tr>
            <th>ƒêi ng·ªß</th>
            <th>Th·ª©c d·∫≠y</th>
            <th>Th·ª±c ng·ªß</th>
            <th>Chu k·ª≥</th>
            <th>Giai ƒëo·∫°n th·ª©c d·∫≠y</th>
            <th>ƒê√°nh gi√° & t∆∞ v·∫•n</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>
  </main>
  <footer>Th√™m v√†o M√†n h√¨nh ch√≠nh tr√™n iPhone ƒë·ªÉ d√πng nh∆∞ app (Share ‚Üí Add to Home Screen)</footer>
  
  <script>
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
    const cycleMin = 90, latencyMinDefault = 15;
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function attachHMBehavior(hhEl, mmEl, maxH=23){
      function cleanDigits(s){ return s.replace(/\D/g,'').slice(0,2); }
      function onInput(e){ const t=e.target; t.value = cleanDigits(t.value); if(t===hhEl && t.value.length===2) mmEl.focus(); }
      function onBlur(e){ const t=e.target; if(!t.value) return; let v=parseInt(t.value,10); v=isNaN(v)?0:v; if(t===hhEl) v=clamp(v,0,maxH); else v=clamp(v,0,59); t.value=pad2(v); }
      function onKeyDown(e){ if(e.key===':'&&e.target===hhEl){ e.preventDefault(); mmEl.focus(); } }
      hhEl.addEventListener('input', onInput); mmEl.addEventListener('input', onInput);
      hhEl.addEventListener('blur', onBlur); mmEl.addEventListener('blur', onBlur);
      hhEl.addEventListener('keydown', onKeyDown); mmEl.addEventListener('keydown', onKeyDown);
    }
    function parseHM(hhEl, mmEl){
      const hh = parseInt(hhEl.value||hhEl.placeholder||'0',10);
      const mm = parseInt(mmEl.value||mmEl.placeholder||'0',10);
      if(isNaN(hh) || isNaN(mm) || hh<0 || hh>23 || mm<0 || mm>59) return null;
      const d = new Date(); d.setHours(hh, mm, 0, 0); return d;
    }
    function fmt24(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}); }
    function minsToHM(min){ const h=Math.floor(min/60), m=min%60; return `${h}h ${pad2(m)}‚Äô`; }
    function stageFromRemainder(r){
      if(r === 0) return {code:'end', name:'Cu·ªëi chu k·ª≥', color:'stage-end', severity:'good', note:'T·ªëi ∆∞u'};
      if(r <= 14) return {code:'n1', name:'N1 (nh·∫π)', color:'stage-n1', severity:'good', note:'D·ªÖ t·ªânh'};
      if(r <= 44) return {code:'n2', name:'N2 (·ªïn ƒë·ªãnh)', color:'stage-n2', severity:'mid', note:'H∆°i l∆° m∆°'};
      if(r <= 74) return {code:'n3', name:'N3 (ng·ªß s√¢u)', color:'stage-n3', severity:'bad', note:'Qu√°n t√≠nh ng·ªß cao'};
      return {code:'rem', name:'REM', color:'stage-rem', severity:'mid', note:'M∆° d·ªü dang'};
    }
  </script>

  <script>
    const tabs = document.querySelectorAll('.tab');
    const panes = { wake: document.getElementById('pane-wake'), bed: document.getElementById('pane-bed') };
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active')); t.classList.add('active');
      const k = t.dataset.tab; Object.values(panes).forEach(p => p.classList.remove('active')); panes[k].classList.add('active');
    }));
    function calcWakeFromBed(){
      const includeLatency = document.getElementById('includeLatencyBed').checked;
      const base = parseHM(document.getElementById('bedHH'), document.getElementById('bedMM'));
      if(!base){ alert('Vui l√≤ng nh·∫≠p gi·ªù ƒëi ng·ªß h·ª£p l·ªá (HH:MM)'); return; }
      const latency = includeLatency ? latencyMinDefault : 0;
      const times = [];
      for(let cycles=3; cycles<=6; cycles++){
        const t = new Date(base.getTime() + (cycles*cycleMin + latency)*60000);
        times.push({t, cycles});
      }
      const rec = times.find(x=>x.cycles===5) || times[Math.floor(times.length/2)];
      renderResults('resultsBed', '‚è∞ Th·ª©c d·∫≠y', times, rec);
    }
    function calcSleepFromWake(){
      const includeLatency = document.getElementById('includeLatencyWake').checked;
      const base = parseHM(document.getElementById('wakeHH'), document.getElementById('wakeMM'));
      if(!base){ alert('Vui l√≤ng nh·∫≠p gi·ªù th·ª©c d·∫≠y h·ª£p l·ªá (HH:MM)'); return; }
      const latency = includeLatency ? latencyMinDefault : 0;
      const times = [];
      for(let cycles=6; cycles>=3; cycles--){
        const t = new Date(base.getTime() - (cycles*cycleMin + latency)*60000);
        times.push({t, cycles});
      }
      const rec = times.find(x=>x.cycles===5) || times[Math.floor(times.length/2)];
      renderResults('resultsWake', 'üåô ƒêi ng·ªß', times, rec);
    }
    function renderResults(targetId, label, times, rec){
      const box = document.getElementById(targetId);
      const recHtml = `<div class=\"recommend\"><span class=\"badge\">Khuy·∫øn ngh·ªã</span><div>${label} l√∫c <strong>${fmt24(rec.t)}</strong> ¬∑ <strong>${rec.cycles}</strong> chu k·ª≥ (~${(rec.cycles*1.5).toFixed(1)} gi·ªù)</div></div>`;
      let listHtml = '<div class="list">';
      times.forEach(x=>{ listHtml += `<div class=\"item\">${fmt24(x.t)}<small>${x.cycles} chu k·ª≥ ¬∑ ~${(x.cycles*1.5).toFixed(1)} gi·ªù</small></div>`; });
      listHtml += '</div>';
      box.innerHTML = '<h3>üìã K·∫øt qu·∫£</h3>' + recHtml + listHtml;
    }

    // Logger
    const STORAGE_KEY = 'sleepLogsV3';
    function addLog(){
      const bed = parseHM(document.getElementById('logBedHH'), document.getElementById('logBedMM'));
      const wake = parseHM(document.getElementById('logWakeHH'), document.getElementById('logWakeMM'));
      if(!bed || !wake){ alert('Vui l√≤ng nh·∫≠p gi·ªù ƒëi ng·ªß/th·ª©c d·∫≠y h·ª£p l·ªá (HH:MM)'); return; }
      let bedT = new Date(bed); let wakeT = new Date(wake);
      if(wakeT <= bedT) wakeT.setDate(wakeT.getDate()+1);
      const includeLatency = document.getElementById('logIncludeLatency').checked;
      const latency = includeLatency ? latencyMinDefault : 0;
      const grossMin = Math.round((wakeT - bedT)/60000);
      const effectiveMin = Math.max(grossMin - latency, 0);
      const cyclesExact = effectiveMin / cycleMin;
      const cyclesRounded = Math.round(cyclesExact*10)/10;
      const cyclesCompleted = Math.floor(cyclesExact);
      let remainder = effectiveMin % cycleMin;
      const stage = stageFromRemainder(remainder);
      const atCycle = remainder === 0 ? cyclesCompleted : cyclesCompleted + 1;
      const earlierAdj = remainder; const laterAdj = cycleMin - remainder;
      const earlierTime = new Date(wakeT.getTime() - earlierAdj*60000);
      const laterTime = new Date(wakeT.getTime() + laterAdj*60000);
      const nearerIsEarlier = earlierAdj <= laterAdj;
      const primaryAdjText = nearerIsEarlier ? `D·∫≠y s·ªõm h∆°n ~${earlierAdj}‚Äô (${fmt24(earlierTime)})` : `D·∫≠y mu·ªôn h∆°n ~${laterAdj}‚Äô (${fmt24(laterTime)})`;
      const secondaryAdjText = nearerIsEarlier ? `ho·∫∑c mu·ªôn h∆°n ~${laterAdj}‚Äô (${fmt24(laterTime)})` : `ho·∫∑c s·ªõm h∆°n ~${earlierAdj}‚Äô (${fmt24(earlierTime)})`;
      let statusTag='tag-mid', statusText='Kh√°';
      if(cyclesExact < 4){ statusTag='tag-bad'; statusText='Thi·∫øu ng·ªß (<4 chu k·ª≥)'; }
      else if(cyclesExact > 6){ statusTag='tag-mid'; statusText='D√†i (>6 chu k·ª≥)'; }
      else { statusTag='tag-good'; statusText='ƒê·ªß 4‚Äì6 chu k·ª≥'; }
      let stageImpact='';
      if(stage.code==='n3'){ stageImpact='Th·ª©c d·∫≠y gi·ªØa N3 (ng·ªß s√¢u) ‚Äì qu√°n t√≠nh ng·ªß cao.'; statusTag='tag-bad'; }
      else if(stage.code==='rem'){ stageImpact='Th·ª©c d·∫≠y trong REM ‚Äì c√≥ th·ªÉ l∆° m∆° do m∆° d·ªü dang.'; if(statusTag!=='tag-bad') statusTag='tag-mid'; }
      else if(stage.code==='n2'){ stageImpact='Th·ª©c d·∫≠y gi·ªØa N2 ‚Äì c√≥ th·ªÉ h∆°i l∆° m∆°.'; }
      else if(stage.code==='n1'){ stageImpact='Th·ª©c d·∫≠y ƒë·∫ßu chu k·ª≥ (N1) ‚Äì d·ªÖ t·ªânh h∆°n.'; }
      else { stageImpact='Th·ª©c ƒë√∫ng cu·ªëi chu k·ª≥ ‚Äì t·ªëi ∆∞u.'; statusTag='tag-good'; }
      let adviceLines = [];
      if(remainder === 0){ adviceLines.push('Gi·ªù d·∫≠y kh·ªõp cu·ªëi chu k·ª≥. Duy tr√¨ gi·ªù ƒëi ng·ªß/d·∫≠y c·ªë ƒë·ªãnh.'); }
      else { adviceLines.push(`${primaryAdjText} ƒë·ªÉ k·∫øt th√∫c chu k·ª≥.`); adviceLines.push(`N·∫øu l·ªãch tr√¨nh cho ph√©p, ${secondaryAdjText}.`); }
      if(cyclesExact < 4){ adviceLines.push('C√¢n nh·∫Øc power nap 10‚Äì20‚Äô tr∆∞·ªõc 15h ƒë·ªÉ b√π t·∫°m.'); }
      if(cyclesExact > 6){ adviceLines.push('C·ªë ƒë·ªãnh gi·ªù d·∫≠y; tr√°nh k√©o d√†i th·ªùi gian tr√™n gi∆∞·ªùng qu√° nhi·ªÅu.'); }
      const row = { id: Date.now(), bed: bedT.getHours()+":"+pad2(bedT.getMinutes()), wake: wakeT.getHours()+":"+pad2(wakeT.getMinutes()), effectiveMin, cyclesRounded, atCycle, stage, statusTag, statusText, stageImpact, adviceLines };
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); list.unshift(row); localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); renderRows();
      document.getElementById('logBedMM').value=''; document.getElementById('logWakeMM').value='';
    }
    function removeRow(id){ const list = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]').filter(x=>x.id!==id); localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); renderRows(); }
    function renderRows(){
      const list = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
      const logBodyEl = document.getElementById('logBody');
      if(list.length===0){ logBodyEl.innerHTML = '<tr><td colspan="7" class="time-help">Ch∆∞a c√≥ ghi nh·∫≠n n√†o. Nh·∫≠p b√™n tr√™n v√† b·∫•m ‚ÄúGhi nh·∫≠n‚Äù.</td></tr>'; return; }
      logBodyEl.innerHTML = list.map(r=>`
        <tr>
          <td>${r.bed}</td>
          <td>${r.wake}</td>
          <td>${minsToHM(r.effectiveMin)}</td>
          <td>${r.cyclesRounded}</td>
          <td><span class="stage ${r.stage.color}">${r.stage.name}${r.stage.code!=='end' ? ` ¬∑ chu k·ª≥ ${r.atCycle}`:''}</span></td>
          <td>
            <div class="evalBox">
              <p><span class="tag ${r.statusTag}">${r.statusText}</span></p>
              <p>‚Ä¢ ${r.stageImpact}</p>
              ${r.adviceLines.map(a=>`<p>‚Ä¢ ${a}</p>`).join('')}
            </div>
          </td>
          <td><button class="button" style="min-width:80px;background:#ffecec;color:#b30000;border:1px solid #ffb3b3" onclick="removeRow(${r.id})">üóë Xo√°</button></td>
        </tr>
      `).join('');
    }
    attachHMBehavior(document.getElementById('bedHH'), document.getElementById('bedMM'));
    attachHMBehavior(document.getElementById('wakeHH'), document.getElementById('wakeMM'));
    attachHMBehavior(document.getElementById('logBedHH'), document.getElementById('logBedMM'));
    attachHMBehavior(document.getElementById('logWakeHH'), document.getElementById('logWakeMM'));
    renderRows();
  </script>
</body>
</html>
